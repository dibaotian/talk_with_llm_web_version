<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>Talk with LLM</h1>
    <button id="start">Start Chat</button>
    <button id="stop" disabled>Stop Chat</button>

    <script>
        const socket = io();
        let recordingContext;
        let playbackContext;
        let mediaStreamSource;
        let isRecording = false;
        let isPlaying = false;
        let audioQueue = [];
        let workletNode;

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        async function startRecording() {
            if (isRecording) return;

            if (!recordingContext) {
                recordingContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            }

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaStreamSource = recordingContext.createMediaStreamSource(stream);

            await recordingContext.audioWorklet.addModule('/static/audio-processor.js');
            workletNode = new AudioWorkletNode(recordingContext, 'audio-processor');

            workletNode.port.onmessage = (event) => {
                socket.emit('audio', event.data);
            };

            mediaStreamSource.connect(workletNode);
            isRecording = true;
        }

        function initPlaybackContext() {
            if (!playbackContext) {
                playbackContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playAudioStream(audioData) {
            if (isPlaying) return;
            isPlaying = true;

            const pcmData = new Int16Array(audioData);
            const floatData = new Float32Array(pcmData.length);
            const sampleRate = 24000;

            for (let i = 0; i < pcmData.length; i++) {
                floatData[i] = pcmData[i] / 32768.0;
            }

            const buffer = playbackContext.createBuffer(1, floatData.length, sampleRate);
            buffer.getChannelData(0).set(floatData);

            const source = playbackContext.createBufferSource();
            source.buffer = buffer;
            source.connect(playbackContext.destination);
            source.onended = () => {
                isPlaying = false;
                playAudioBuffer();
            };
            source.start();
        }

        function playAudioBuffer() {
            if (audioQueue.length > 0 && !isPlaying) {
                const nextAudio = audioQueue.shift();
                playAudioStream(nextAudio);
            }
        }

        socket.on('play_audio_stream', (data) => {
            initPlaybackContext();
            const audioData = base64ToArrayBuffer(data.data);
            audioQueue.push(audioData);
            playAudioBuffer();
        });

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        document.getElementById('start').onclick = async () => {
            try {
                await startRecording();
                document.getElementById('start').disabled = true;
                document.getElementById('stop').disabled = false;
            } catch (error) {
                console.error('Error accessing microphone:', error);
            }
        };

        document.getElementById('stop').onclick = () => {
            if (isRecording) {
                mediaStreamSource.disconnect();
                if (workletNode) {
                    workletNode.disconnect();
                }
                recordingContext.close();
                isRecording = false;

                socket.emit('stop');

                document.getElementById('start').disabled = false;
                document.getElementById('stop').disabled = true;
                console.log('Recording stopped.');
            }
        };
    </script>
</body>
</html>